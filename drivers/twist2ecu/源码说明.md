# 1 twist2ecu.cpp

这个程序会完成twist数据格式到ecu数据格式的转换并再发布, **node名为twist2ecu**, **订阅topic名为chatter_twist**, **发布topic名为chatter_ecu**

### 1.1 头文件

```cpp
#include <ros/ros.h>
#include <geometry_msgs/TwistStamped.h>
#include <trans/ecu.h> // 第三方库, 由编译器根据ecu.msg自动生成
#define _USE_MATH_DEFINES // 使用M_PI宏定义3.1415926
```

### 1.2 主函数

```cpp
int main(int argc, char *argv[])
{
    //保证编码格式符合本机格式, 不太清楚具体用途
    setlocale(LC_ALL, "");
    
    // 1. 初始化ROS节点, node名为twist2ecu
    ros::init(argc, argv, "twist2ecu");

    // 2. 创建Sub_And_Pub这个类, 其中会处理好订阅->处理->再发布的操作
    Sub_And_Pub SAPObject;

    // 4. 回调函数处理, 进入ros::spin()所创建的回调函数循环
    ros::spin();
    
    return 0;
}
```

### 1.3 负责订阅，处理，再发布的class——Sub_And_Pub

```cpp
class Sub_And_Pub
{
public:
    Sub_And_Pub()
    {
        // 该节点要发布的话题
        pub = n.advertise<trans::ecu>("/published_topic_ecu", 1);

	    // 该节点要订阅的话题, 并且这个订阅话题是需要通过回调函数处理的
        sub = n.subscribe("/chatter_twist", 1, &Sub_And_Pub::twist2ecu_callback, this);
    }

    void twist2ecu_callback(const geometry_msgs::TwistStamped twist_input)
    {
        trans::ecu ecu_output;
        
        //换算操作
        /* 需要说明的
           ecu格式中最重要的两个数据：motor——目标速度 m/s, steer——转向角度 度
           twist格式中最重要的两个数据: linear.x——车辆速度 m/s, angular.z——偏航角转向速度 rad/s
           我重点是根据这两个数据进行twist2ecu换算
        */
	ecu_output.motor = twist_input.twist.linear.x;
	ecu_output.steer += (twist_input.twist.angular.z * 180 / M_PI) * 1; //  频率为1Hz
	if (ecu_output.steer > 120)
            ecu_output.steer = 30;
    if (ecu_output.steer < -120)
            ecu_output.steer = -30;
        
	    //发布节点
        pub.publish(ecu_output);
    }
    
private:
    ros::NodeHandle n;
    ros::Publisher pub;
    ros::Subscriber sub;
};
```

# 2 目前需要解决的

我觉得整个程序最重要的地方, 就是换算操作怎么编写, 摆在眼前的一个问题是：

### 2.1 如何去考虑订阅和发布频率的事情？

首先，我们这个换算程序需要接收上级控制算法传递过来的信息，这是有一定频率的：

twist数据传进来是以一定频率的，而在twist2ecu的转换过程中，我们需要用到这个频率去做angular.z到steer的转换，简单来说，如果我知道twist的传输频率，一切都能很简单的解决, twist的传输频率大概藏在源码或者某些launch里。

如果我找不到, 也能解决, 我们只需要增加twist2ecu的发布频率就好了, 我们根据这个发布频率去做换算

这个就像是**短板效应**，最后计算所使用的频率是根据最大的那个发布频率去做的

### 2.2 ecu还存在大量的常量，我需要知道他们都应该怎么设置



# 3 测试

#### 终端1

```
roscore
```

#### 终端2——负责发布twist数据

```
cd twist2ecu
source ./devel/setup.bash
rosrun trans twist_talker
```

#### 终端3

```
cd twist2ecu
source ./devel/setup.bash
rosrun trans twist2ecu
```

#### rqt_graph

![image-20231031151217363](/home/mhy/.config/Typora/typora-user-images/image-20231031151217363.png)

这里twist2ecu没显示发布的topic, 是因为这个topic没人订阅, 自动隐藏了

#### rostopic echo

![img](file:////home/mhy/.config/QQ/nt_qq_43ae27ebb1cdc53b4de043ae3f50e5d1/nt_data/Pic/2023-10/Ori/e1fd9f917cb2b684df4b5b7a914f25bf.png)

红框中的转换数据是正常的，左上是ecu, 右下是twist
